CREATE OR REPLACE FUNCTION votes(text, integer) 
RETURNS integer AS
$BODY$
  declare result integer;
  BEGIN
    select
      SUM(CASE WHEN vote = 'up' THEN 1 ELSE -1 END) as votes into result
    from
      votes 
    where
      entry_type=$1 and entry_id=$2;
    if result is null then
      return 0;
    else
      return result;
    end if;
  END; 
$BODY$ LANGUAGE plpgsql;
  
drop function answer(integer);
CREATE OR REPLACE FUNCTION answer(integer)
RETURNS json
AS
$BODY$
  DECLARE j json;
  BEGIN
    select
      row_to_json(comments) into j
    from
      comments 
    where
      comments.answer is not null and question_id=$1;
    if j is null then
      return null;
    else
      return j;
    end if;
  END; 
$BODY$ LANGUAGE plpgsql;

CREATE OR REPLACE FUNCTION answer(integer,out answer text,out answered timestamptz,out answered_by text)
AS
$BODY$
  DECLARE a text;
  DECLARE b timestamptz;
  DECLARE c text;
  BEGIN
    select
      comments.comment,comments.answered,comments.answer into a,b,c
    from
      comments 
    where
      comments.answer is not null and question_id=$1;
    answer := a;
    answered := b;
    answered_by := c;
  END; 
$BODY$ LANGUAGE plpgsql;
