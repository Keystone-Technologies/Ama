<html>
    <head>
        %= javascript '/js/url_for.js'
        <link rel="stylesheet" type="text/css" href="/css/style.css">
        <link href='https://fonts.googleapis.com/css?family=Noto+Sans:400,700' rel='stylesheet' type='text/css'>
        <script language="javascript" type="text/javascript" src="/js/scripts.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>    
    </head>
    <title>Keystone Moderator</title>
<body>
        <a href='https://www.youtube.com/channel/UCwSuyK7EsrNN02Z92bI34gA/feed' ><img id='youtube' src='/img/youtube.png' onmouseover='youtubehover(true);' onmouseout='youtubehover(false);' data-toggle='true' title='KSTN video blog on YouTube'></a>
    <div id="newquestion">
        <h3 id="newquestionbutton">+ New Question</h3>
    </div>
    <div class="header" id="bar">
        <input class="header" id="logo" type="image" src="/img/logo.png">
    </div>
    <div id="errorcontainer" class="error">
    Error: Unable to complete task
    </div>
    <div id="content">
        % for my $question (@$questions) {
            % my $question_id = $question->{question_id};
            % warn $question_id;
            % if (!$question->{answered}) {
                <div id="question_<%= $question_id %>" class="question<%= $question->{answered} ? 'answered' : 'unanswered' %>container">
                    <div class="questioninfocontainer">
                        <div class="votecontainer">
                            <div id="vote_<%= $question_id %>" class="vote">
                            
                                <img id="up_<%= $question_id %>" class="vote_up" src="/img/uparrow.png" onmouseover="arrowhover(this.id, this.className, 'over');" onmouseout="arrowhover(this.id, this.className, 'out');">
                                <div id="countcontainer_<%= $question_id %>" class="count">
                                    <p id="count_<%= $question_id %>" class="countnumber"><%= $question->{votes} %></p>
                                </div>
                                    <script>
                                        $(document).ready(function(){
                                            var clicked = false;
                                            console.log("up <%= $question_id %>");
                                            $("#up_<%= $question_id %>").click(function(){
                                                $(this).attr("onmouseout", "");
                                                $(this).attr("onmouseover", "");
                                                $(this).attr("src", "/img/clickeduparrow.png");
                                                $("#down_<%= $question_id %>").attr("onmouseout", "arrowhover(this.id, this.className, 'out');");
                                                $("#down_<%= $question_id %>").attr("onmouseover", "arrowhover(this.id, this.className, 'over');");
                                                $("#down_<%= $question_id %>").attr("src", "/img/downarrow.png");
                                                $.post("<%= url_for 'cast_vote', {entry_type=>'questions', entry_id=>$question_id, vote=>'up'} %>", function(data){
                                                    console.log(data);
                                                    $("#count_<%= $question_id %>").html(data.votes);
                                                }, 'json');
                                            });
                                        });
                                    </script>
                                <img id="down_<%= $question_id %>" class="vote_down" src="/img/downarrow.png" onmouseover="arrowhover(this.id, this.className, 'over');" onmouseout="arrowhover(this.id, this.className, 'out');">
                                    <script>
                                        $(document).ready(function(){
                                            console.log("down <%= $question_id %>");
                                            $("#down_<%= $question_id %>").click(function(){
                                                $(this).attr("onmouseout", "");
                                                $(this).attr("onmouseover", "");
                                                $(this).attr("src", "/img/clickeddownarrow.png");
                                                $("#up_<%= $question_id %>").attr("onmouseout", "arrowhover(this.id, this.className, 'out');");
                                                $("#up_<%= $question_id %>").attr("onmouseover", "arrowhover(this.id, this.className, 'over');");
                                                $("#up_<%= $question_id %>").attr("src", "/img/uparrow.png");
                                                $.post("<%= url_for 'cast_vote', {entry_type=>'questions', entry_id=>$question_id, vote=>'down'} %>", function(data){
                                                    console.log(data);
                                                    $("#count_<%= $question_id %>").html(data.votes);
                                                }, 'json');
                                            });
                                        });
                                    </script>
                                % if ($question->{flagged}){
                                    <script>
                                    $(document).ready(function(){
                                        $("#vote_<%= $question_id %>").css('display', 'none');
                                        $("#questionbuttoncontainer_<%= $question_id %>").prepend("<div id='flaggedcount_<%= $question_id %>' class='flaggedcount'><p class='countnumber'><%= $question->{votes} %></p></div>");
                                    });
                                    </script>
                                % }
                            </div>
                            <div id="questionbuttoncontainer_<%= $question_id %>" class="questionbuttoncontainer">
                                % if ( $question->{username} eq session 'username' ) {
                                <div class="deletecontainer">
                                    <img id="deletequestion_<%= $question_id %>" class="deletequestionbutton" src="/img/trash.png" data-toggle='tooltip' title='Delete question'>
                                </div>
                                % }
                                <div id="flagcontainer_<%= $question_id %>" class="flagcontainer">
                                    <img id="flag_<%= $question_id %>" class="flag" src="/img/flag.png" data-toggle='tooltip' title='Flag question' onmouseover='flaghover(this.id, true)' onmouseout='flaghover(this.id, false)'>
                                </div>
                                % if (!$question->{flagged}){
                                <script>
                                    $(document).ready(function(){
                                        $("#flagcontainer_<%= $question_id %>").click(function() {questionflagclick("<%= $question_id %>", "<%= $question->{votes} %>")});
                                    });
                                </script>
                                % } else {
                                <script>
                                    $(document).ready(function(){
                                        $("#flagcontainer_<%= $question_id %>").click(function(){questionredflagclick("<%= $question_id %>", "<%= $question->{votes} %>")});
                                    });
                                </script>
                                % }
                            </div>
                        </div>
                        <div id="questiontime_<%= $question->{created} %>" class="questiontime">
                            <h4><%= $question->{created} %></h4>
                        </div>
                    </div>
                    <script>
                        $(document).ready(function(){
                            $("#deletequestion_<%= $question_id %>").click(function(){
                                $.ajax({
                                    url: "<%= url_for 'remove_question', {question_id => $question_id} %>", type: 'DELETE'
                                });
                                console.log('Deleted question # <%= $question_id %>');
                                $("#question_<%= $question_id %>").remove();
                                $("#commentcontainer_<%= $question_id %>").remove();
                            });
                            $("#deletequestion_<%= $question_id %>").mouseover(function(){
                                $(this).attr("src", "/img/opentrash.png");
                            });
                            $("#deletequestion_<%= $question_id %>").mouseout(function(){
                                $(this).attr("src", "/img/trash.png");
                            });
                            
                        });
                    </script>
                    <div class="question">
                        <h1 id="questiontitle_<%=$question_id %>" class="questionunansweredtitle"><%= $question->{question} %></h1>
                        <div id="<%= $question_id %>" class="infobar">
                            <h4 id="showcomments_<%= $question_id %>" class="info">Show Comments (<%= $question->{comment_count} %>)</h4>
                            <h4 id="reply_<%= $question_id %>" class ="info">Reply</h4>
                            % if ($question->{flagged}){
                                <script>
                                $(document).ready(function(){
                                    $("#reply_<%= $question_id %>").css('display', 'none');
                                });
                                </script>
                            % }
                        </div>
                    </div>
                    <script>
                    $(document).ready(function(){
                        if("<%= $question->{username} %>" == "<%= session 'username' %>"){
                            var questionformshown = false;
                            var question = "<%= $question->{question} %>";
                            $("#questiontitle_<%= $question_id %>").click(function(){
                                if (!questionformshown) {
                                    var questioneditHTML = "<form id='questionform_<%= $question_id %>'>\
                                        <label class='questionlabel' for='question'>Edit Question</label>\
                                        <br><textarea id='questiontextarea_<%= $question_id%>' name='question' required>" + question + "</textarea>\
                                        <input type='hidden' name='question_id' value='<%= $question_id %>'>\
                                        </form><input id='questioneditsubmit_<%= $question_id%>' class='questionpostbutton' type='submit' value='Post'>\
                                        "
                                    $("#question_<%= $question_id%>").after(questioneditHTML);
                                    questionformshown = true;
                                    $("#questioneditsubmit_<%= $question_id%>").click(function(){
                                        var message = $("#questiontextarea_<%= $question_id%>").val();
                                        $.ajax({url: url_for('update_question', {question_id: "<%= $question_id%>"}),
                                        type: "PUT",
                                        contentType: "application/x-www-form-urlencoded",
                                        dataType: 'json',
                                        data: {question_id: "<%= $question_id%>", question: message}})
                                        .done(function(data){
                                            $("#questionform_<%= $question_id %>").remove();
                                            $("#questioneditsubmit_<%= $question_id %>").remove();
                                            $("#questiontitle_<%= $question_id %>").text(data.question);
                                            question = data.question;
                                            questionformshown = false;
                                            console.log(data);
                                            });
                                    });
                                    
                                }
                                else {
                                    $("#questionform_<%= $question_id %>").remove();
                                    $("#questioneditsubmit_<%= $question_id %>").remove();
                                    questionformshown = false;
                                }
                            });
                        }
                        else {
                            $("#questiontitle_<%= $question_id %>").css('cursor','text');
                        }
                    });
                    </script>
                    <script>
                        $(document).ready(function(){
                            $(".replyformcontainer").toggle(false);
                            $("#reply_<%= $question_id %>").click(function(){
                                if ($("#reply_<%= $question_id %>").html() == '- Hide'){
                                    $("#reply_<%= $question_id %>").html('Reply');
                                    $("#replyformcontainer_<%= $question_id %>").toggle(false);
                                }
                                else {
                                    $("#reply_<%= $question_id %>").html('- Hide');
                                    $("#replyformcontainer_<%= $question_id %>").toggle(true);
                                }
                            });
                            $("#submit_<%= $question_id %>").click(function(){
                                var mycomment = $.trim($("#newcommenttext_<%= $question_id %>").val());
                                console.log(mycomment);
                                $.ajax({url: url_for('store_comment', {question_id: "<%= $question_id%>"}),
                                        type: "POST",
                                        contentType: "application/x-www-form-urlencoded",
                                        dataType: 'json',
                                        data: {question_id: "<%= $question_id%>", comment: mycomment}})
                                        .done(function(data){
                                            $("#newcommenttext_<%= $question_id %>").val('');
                                            $("#replyformcontainer_<%= $question_id %>").toggle(false);
                                            $("#reply_<%= $question_id %>").html('Reply');
                                            if ($("#showcomments_<%= $question_id %>").html() == 'Hide Comments'){
                                                $("#showcomments_<%= $question_id %>").trigger('click');
                                            }
                                            globalloaded = false;
                                            $("#showcomments_<%= $question_id %>").trigger('click');
                                        });
                                });
                        });
                    </script>
                </div>
                <div id="commentcontainer_<%= $question_id %>" class="commentcontainer">
                </div>
                <div id="replyformcontainer_<%= $question_id %>" class="replyformcontainer">
                    <form id='commentform_<%= $question_id %>'>
                        <label class='commentlabel' for='comment'>Comment</label>
                        <br><textarea id="newcommenttext_<%= $question_id %>" name='comment' required></textarea>
                        <input type='hidden' name='question_id' value='<%= $question_id %>'>
                    </form>
                    <input id="submit_<%= $question_id %>" class="replypostbutton" type='submit' value='Post'>
                </div>
                <script>
                    $(document).ready(function(){
                        globalloaded = true;
                        var shown = false;
                        var loaded = false;
                        $("#showcomments_<%= $question_id %>").click(function(){
                            console.log("Global loaded: " + globalloaded);
                            console.log("Loaded: " + loaded);
                            if (!globalloaded){
                                loaded = false;
                                globalloaded = true;
                            }
                            if (shown){
                                $("#commentcontainer_<%= $question_id %>").toggle(false);
                                $("#showcomments_<%= $question_id %>").html("Show Comments (<%= $question->{comment_count}%>)");
                                shown = false;
                            }
                            else {
                                if (!loaded){  //Load comments for question via post request
                                    var HTMLstring = "";
                                    $.get("<%= url_for 'comments', {question_id => $question_id} %>", function(data){
                                        $.each(data, function(i, v){
                                            console.log(v);
                                            var markanswerattributes = "";
                                            var deletecommentattributes = "";
                                            var commenttextattributes = "";
                                            var commentflagattributes = "";
                                                if (v.username == "<%= session 'username' %>") {
                                                    deletecommentattributes = ""
                                                    commenttextattributes = "showable='true' style='cursor:pointer'";
                                                }
                                                else {
                                                    deletecommentattributes = "style='display:none'";
                                                    commenttextattributes = "style='cursor:text'";
                                                }
                                                if("<%= $question->{username} %>" == "<%= session 'username' %>"){
                                                    markanswerattributes = "src='/img/checkmark.png' data-toggle='tooltip' title='Mark as answer' onclick='answerbuttonclick(" + v.comment_id + ", false, " + v.question_id + ");' \
                                                    onmouseover='answerbuttonhover(this.id, false, true);' onmouseout='answerbuttonhover(this.id, false, false);' style='cursor:pointer' showable='true'";
                                                }
                                                else {
                                                    markanswerattributes = "style='display:none'";
                                                }
                                                if (!v.flagged){
                                                    HTMLstring = HTMLstring + (
                                                        "<div id='comment_" + v.comment_id + "' class='comment'>\
                                                        <span id='commentvotecount_" + v.comment_id + "' class='commentvotecount'>" + v.votes + "</span><div id='commentvotecontainer_" + v.comment_id + "' class='commentvotecontainer'>\
                                                        <img id='commentup_" + v.comment_id + "' class='commentup' src='/img/smalluparrow.png'>\
                                                        <img id='commentdown_" + v.comment_id + "' class='commentdown' src='/img/smalldownarrow.png'></div>\
                                                        <span id='commenttime_" + v.comment_id + "' class='commenttime' ><h4>" + v.created + "</h4></span><img id='markanswer_" + v.comment_id + "' \
                                                        class='markanswerbutton' question_id='" + v.question_id + "' " + markanswerattributes + ">\
                                                        <img id='delete_" + v.comment_id + "' question_id='" + v.question_id + "' class='deletecommentbutton' src='/img/trash.png' data-toggle='tooltip' title='Delete comment' " + deletecommentattributes + ">\
                                                        <img id='commentflag_" + v.comment_id + "' question_id='" + v.question_id + "' class='flagcommentbutton' flagged='false' src='/img/flag.png' data-toggle='tooltip' title='Flag comment' onmouseover='flaghover(this.id, true);' onmouseout='flaghover(this.id, false);'>\
                                                        <span class='commenttext' id='commenttext_" + v.comment_id + "' question_id='" + v.question_id + "' data-toggle='tooltip' title='Click to edit' " + commenttextattributes + ">\
                                                        " + v.comment + "</span></div>");
                                                }
                                                else {
                                                    HTMLstring = HTMLstring + (
                                                        "<div id='comment_" + v.comment_id + "' class='comment'>\
                                                        <span id='commentvotecount_" + v.comment_id + "' class='commentvotecount'>" + v.votes + "</span><div id='commentvotecontainer_" + v.comment_id + "' class='commentvotecontainer' style='display:none'>\
                                                        <img id='commentup_" + v.comment_id + "' class='commentup' src='/img/smalluparrow.png'>\
                                                        <img id='commentdown_" + v.comment_id + "' class='commentdown' src='/img/smalldownarrow.png'></div>\
                                                        <span id='commenttime_" + v.comment_id + "' class='commenttime' ><h4>" + v.created + "</h4></span><img id='markanswer_" + v.comment_id + "' \
                                                        class='markanswerbutton' question_id='" + v.question_id + "' " + markanswerattributes + ">\
                                                        <img id='delete_" + v.comment_id + "' question_id='" + v.question_id + "' class='deletecommentbutton' src='/img/trash.png' data-toggle='tooltip' title='Delete comment' " + deletecommentattributes + ">\
                                                        <img id='commentflag_" + v.comment_id + "' question_id='" + v.question_id + "' class='flagcommentbutton' flagged='true' src='/img/redflag.png' data-toggle='tooltip' title='Unflag comment' onmouseover='redflaghover(this.id, true);' onmouseout='redflaghover(this.id, false);'>\
                                                        <span class='commenttext' style='background:#000000' id='commenttext_" + v.comment_id + "' question_id='" + v.question_id + "' data-toggle='tooltip' title='Click to edit' " + commenttextattributes + ">\
                                                        " + v.comment + "</span></div>");
                                                }
                                                
                                                
                                                $("#commentcontainer_<%= $question_id %>").html(HTMLstring);
                                        });
                                        $(".commentup").each(function(){
                                            
                                            $(this).mouseout(function(){
                                                $(this).attr('src','/img/smalluparrow.png');
                                            });
                                            $(this).mouseover(function(){
                                                $(this).attr('src','/img/clickedsmalluparrow.png');
                                            });
                                            $(this).click(function(){
                                                var commentid = $(this).attr("id");
                                                idobject = /(\d+)/.exec(commentid);
                                                id = idobject[1];
                                                console.log(id);
                                                $(this).attr('src','/img/clickedsmalluparrow.png');
                                                $(this).unbind('mouseout');
                                                $(this).unbind('mouseover');
                                                $("#commentdown_" + id).attr('src', '/img/smalldownarrow.png');
                                                $("#commentdown_" + id).mouseout(function(){
                                                    $(this).attr('src','/img/smalldownarrow.png');
                                                });
                                                $("#commentdown_" + id).mouseover(function(){
                                                    $(this).attr('src','/img/clickedsmalldownarrow.png');
                                                });
                                                $.post(url_for('cast_vote', {entry_type: 'comments', entry_id: id, vote: 'up'}), function(data){
                                                    $("#commentvotecount_" + id).html(data.votes);
                                                }, 'json');
                                                console.log(data);
                                            });
                                        });
                                        $(".commentdown").each(function(){
                                            $(this).mouseout(function(){
                                                $(this).attr('src','/img/smalldownarrow.png');
                                            });
                                             $(this).mouseover(function(){
                                                $(this).attr('src','/img/clickedsmalldownarrow.png');
                                            });
                                            $(this).click(function(){
                                                var commentid = $(this).attr("id");
                                                idobject = /(\d+)/.exec(commentid);
                                                id = idobject[1];
                                                $(this).attr('src','/img/clickedsmalldownarrow.png');
                                                $(this).unbind('mouseout');
                                                $(this).unbind('mouseover');
                                                $("#commentup_" + id).attr('src', '/img/smalluparrow.png');
                                                $("#commentup_" + id).mouseout(function(){
                                                    $(this).attr('src','/img/smalluparrow.png');
                                                });
                                                $("#commentup_" + id).mouseover(function(){
                                                    $(this).attr('src','/img/clickedsmalluparrow.png');
                                                });
                                                $.post(url_for('cast_vote', {entry_type: 'comments', entry_id: id, vote: 'down'}), function(data){
                                                    $("#commentvotecount_" + id).html(data.votes);
                                                }, 'json');
                                                console.log('post success');
                                                console.log(data);
                                                
                                            });
                                        });
                                        
                                        $(".deletecommentbutton").each(function(){
                                            var id = $(this).attr("id");
                                            var question_id = $(this).attr("question_id");
                                            idobject = /(\d+)/.exec(id);
                                            var comment_id = idobject[1];
                                            $("#" + id).click(function(){
                                                $.ajax({
                                                    url: url_for('remove_comment', 
                                                    {comment_id: comment_id}), 
                                                    type: 'DELETE',
                                                    dataType: 'json'
                                                });
                                                console.log('Deleted comment #' + comment_id);
                                                $("#comment_" + comment_id).remove();
                                            });
                                            $("#" + id).mouseover(function(){
                                                $(this).attr("src", "/img/opentrash.png");
                                            });
                                            $("#" + id).mouseout(function(){
                                                $(this).attr("src", "/img/trash.png");
                                            });
                                        });
                                        $(".markanswerbutton").each(function(){
                                            var id = $(this).attr("id");
                                            var question_id = $(this).attr("question_id");
                                            idobject = /(\d+)/.exec(id);
                                            var comment_id = idobject[1];
                                            
                                        });
                                        
                                        $(".flagcommentbutton").each(function(){
                                            var id = $(this).attr("id");
                                            var question_id = $(this).attr("question_id");
                                            idobject = /(\d+)/.exec(id);
                                            var comment_id = idobject[1];
                                            if ($(this).attr('flagged') == 'false'){
                                                $("#commentflag_" + comment_id).click(function(){commentflagclick(comment_id)});
                                            }
                                            else {
                                                $("#commentflag_" + comment_id).click(function(){commentredflagclick(comment_id)});
                                            }
                                        });
                                        
                                        $(".commenttext").each(function(){
                                            var commentid = $(this).attr("id");
                                            var question_id = $(this).attr("question_id");
                                            idobject = /(\d+)/.exec(commentid);
                                            var comment_id = idobject[1];
                                            var editformshown = false;
                                            if ($(this).attr('showable') == 'true'){
                                                var comment = $.trim($("#commenttext_" + comment_id).text());
                                                $("#" + commentid).click(function(){
                                                    if (!editformshown) {
                                                        var commenteditHTML = "<form id='commentform_<%= $question_id %>'><br>\
                                                            <label class='commentlabel' for='comment'>Edit Comment</label>\
                                                            <br><textarea id='textarea_" + question_id + "' name='comment' required>" + comment + "</textarea>\
                                                            <input type='hidden' name='question_id' value='<%= $question_id %>'>\
                                                            </form><input id='editsubmit_<%= $question_id%>' class='commentpostbutton' type='submit' value='Post'>"
                                                        $("#comment_" + comment_id).after(commenteditHTML);
                                                        $("#editsubmit_" + question_id).click(function(){
                                                            var message = $("#textarea_" + question_id).val();
                                                            $.ajax({url: url_for('update_comment', {comment_id: comment_id}),
                                                            type: "PUT",
                                                            contentType: "application/x-www-form-urlencoded",
                                                            dataType: 'json',
                                                            data: {question_id: question_id, comment: message}})
                                                            .done(function(data){
                                                                console.log(data);
                                                                $("#commentform_<%= $question_id %>").remove();
                                                                $("#editsubmit_<%= $question_id %>").remove();
                                                                comment = data.comment;
                                                                $("#textarea_<%= $question_id %>").text(comment);
                                                                $("#commenttext_" + comment_id).text(comment);
                                                                editformshown = false;
                                                            });
                                                        });
                                                        editformshown = true;
                                                    }
                                                    else {
                                                        $("#commentform_<%= $question_id %>").remove();
                                                        $("#editsubmit_<%= $question_id %>").remove();
                                                        editformshown = false;
                                                    }
                                                });
                                            }
                                        });
                                    }, 'json');
                                    loaded = true;
                                }
                                shown = true;
                                $("#commentcontainer_<%= $question_id %>").toggle(true);
                                $("#showcomments_<%= $question_id %>").html("Hide Comments");
                                console.log('Comments displayed');
                            }
                        });
                    });
                </script>
                    </div>
                % if ($question->{flagged}){
                    <script>
                    $(document).ready(function(){
                        $("#questiontitle_<%= $question_id%>").css('background', '#000000');
                        $("#flag_<%= $question_id%>").attr('src', '/img/redflag.png');
                        $("#flag_<%= $question_id%>").attr('onmouseover', 'redflaghover(this.id, true)');
                        $("#flag_<%= $question_id%>").attr('onmouseout', 'redflaghover(this.id, false)');
                        $("#flag_<%= $question_id%>").attr('title', 'Unflag Question');
                    });
                    </script>
                % }
                    
                    
            % } else {
                <div id="question_<%= $question_id %>" class="questionansweredcontainer">
                    <div class="questioninfocontainer">
                        <div class="answeredquestionbuttoncontainer">
                        <div class="answeredcount">
                            <p id="count_<%= $question_id %>" class="countnumber"><%= $question->{votes} %></p>
                        </div>
                        </div>
                        <div id="questiontime_<%= $question->{created} %>" class="questiontime">
                            <h4><%= $question->{created} %></h4>
                        </div>
                    </div>
                    <div class="question">
                        <h1 class="questionansweredtitle"><%= $question->{question} %></h1>
                        <div id="<%= $question_id %>" class="infobar">
                            <h4 id="showcomments_<%= $question_id %>" class="info">Show Comments (<%= $question->{comment_count} %>)</h4>
                        </div>
                    </div>
                </div>
                <div id="commentcontainer_<%= $question_id %>" class="commentcontainer">
                </div>
                <script>
                    $(document).ready(function(){
                        var shown = false;
                        var loaded = false;
                        $("#showcomments_<%= $question_id %>").click(function(){
                            if (shown){
                                $("#commentcontainer_<%= $question_id %>").toggle(false);
                                $("#showcomments_<%= $question_id %>").html("Show Comments (<%= $question->{comment_count} %>)");
                                shown = false;
                            }
                            else {
                                if (!loaded){  //Load comments for question via post request
                                    var HTMLstring = "";
                                    console.log('Loading comment data');
                                    $.get("<%= url_for 'comments', {question_id => $question_id} %>", function(data){
                                        console.log(data);
                                        $.each(data, function(i, v){
                                            var markanswerattributes = "";
                                            var commentbackground = "";
                                                if ("<%=$question->{username} %>" == "<%= session 'username' %>") {
                                                    if (v.answered){
                                                        markanswerattributes = "src='/img/checkedcheckmark.png' onclick='answerbuttonclick(" + v.comment_id + ", true, " + v.question_id + ");' onmouseover='answerbuttonhover(this.id, true, true);'\
                                                        onmouseout='answerbuttonhover(this.id, true, false);' data-toggle='tooltip' answered='true' title='Unmark as answer' style='cursor:pointer'";
                                                        commentbackground = "style='background:#ffffff'";
                                                    }
                                                    else {
                                                        markanswerattributes = "src='/img/checkmark.png' data-toggle='tooltip' title='Mark as answer' onclick='answerbuttonclick(" + v.comment_id + ", false, " + v.question_id + ");' \
                                                        onmouseover='answerbuttonhover(this.id, false, true);' onmouseout='answerbuttonhover(this.id, false, false);' style='cursor:pointer'";
                                                    }
                                                }
                                                else {
                                                    if (v.answered){
                                                        markanswerattributes = "src='/img/checkedcheckmark.png' answered='true'";
                                                        commentbackground = "style='background:#ffffff'";
                                                    }
                                                    else {
                                                        markanswerattributes = "style='display:none'";
                                                    }
                                                }
                                            HTMLstring = HTMLstring + (
                                                "<div id='comment_" + v.comment_id + "' class='answeredcomment' " + commentbackground + " >\
                                                <span id='commentvotecount_" + v.comment_id + "' class='commentvotecount'>" + v.votes + "</span>\
                                                <span id='commenttime_" + v.comment_id + "' class='commenttime' ><h4>" + v.created + "</h4></span><img id='markanswer_" + v.comment_id + "' \
                                                class='markanswerbutton' question_id='" + v.question_id + "' " + markanswerattributes + ">\
                                                <span class='commenttext' id='commenttext_" + v.comment_id + "' question_id='" + v.question_id + "' >\
                                                " + v.comment + "</span></div>");
                                                $("#commentcontainer_<%= $question_id %>").html(HTMLstring);
                                        });
                                    }, 'json');
                                    loaded = true;
                                }
                                shown = true;
                                $("#commentcontainer_<%= $question_id %>").toggle(true);
                                $("#showcomments_<%= $question_id %>").html("Hide Comments");
                                console.log('Comments displayed');
                            }
                        });
                    });
                </script>
                </div>
                
            % } 
        % }
            <script>
                $(document).ready(function(){
                    var formshown = false;
                    $("#newquestion").click(function(){
                        if (formshown){
                            $("#newquestionbutton").html('+ New Question');
                            $("#content").css("padding-top", "50px");
                            $("#newquestionform").remove();
                            formshown = false;
                        }
                        else {
                            $("#newquestionbutton").html('- Hide');
                            $("#content").css("padding-top", "0px");
                            $("#bar").after(
                                "<form id='newquestionform' action='<%= url_for 'store_question' %>' method='POST'>\
                                <label for='question'>New Question</label><br>\
                                <textarea name='question' required></textarea><br>\
                                <input class='postbutton' type='submit' value='Create'></form>");
                            formshown = true;
                        }
                    });
                });
            </script>
        </div>
    </body>
</html>